# Web application for managing book list

## Описание

Это веб-приложение для управления списком книг, которое использует современные технологии для обеспечения производительности, отказоустойчивости и масштабируемости. В проекте реализованы следующие возможности:

- **CRUD операции** (создание, чтение, обновление и удаление) для книг через REST API.
- Взаимодействие с **PostgreSQL** для хранения данных.
- Кеширование с помощью **Redis** для оптимизации производительности.
- **RabbitMQ** используется для обработки асинхронных сообщений (например, уведомлений о создании/обновлении/удалении книг).
- **gRPC сервис** для удаленного получения информации о книгах.
- В проекте используется **FastAPI** для реализации REST API, с удобной встроенной документацией.
- Механизм повторных попыток с использованием декоратора **`@retry`** для надёжного взаимодействия с внешними сервисами и базой данных.

## Технологии

### 1. **FastAPI**

FastAPI — это современный и быстрый веб-фреймворк для создания API. Он обладает высокой производительностью благодаря использованию асинхронного программирования. Преимущества:

- Встроенная поддержка **OpenAPI** и автоматическая документация.
- Асинхронная обработка запросов для повышения производительности.
- Простота использования и богатый функционал для валидации данных.

### 2. **PostgreSQL** + **SQLAlchemy**

PostgreSQL — это реляционная база данных, известная своей надежностью и поддержкой ACID-транзакций. В проекте используется **SQLAlchemy** для взаимодействия с PostgreSQL:

- Поддержка асинхронных операций через **SQLAlchemy** позволяет эффективно работать с базой данных, не блокируя основной поток.
- PostgreSQL предоставляет возможности для сложных запросов, масштабирования и высокой производительности.

### 3. **Redis**

Redis используется для кеширования данных, что значительно ускоряет доступ к часто запрашиваемым данным и снижает нагрузку на базу данных. Преимущества:

- Высокая скорость благодаря хранению данных в памяти.

### 4. **RabbitMQ**

RabbitMQ — это брокер сообщений, который используется для асинхронной обработки сообщений (например, уведомлений о создании или обновлении данных). Преимущества:

- Асинхронная обработка задач, что повышает масштабируемость системы.
- Надежность передачи сообщений и балансировка нагрузки.

### 5. **gRPC**

gRPC используется для удаленного вызова методов между различными микросервисами. В проекте реализован сервис для получения данных о книгах:

- Высокая производительность благодаря бинарному протоколу **Protocol Buffers**.
- Поддержка стриминга и асинхронного взаимодействия.

## Инструкция по развёртыванию проекта

### Требования

- **Docker** и **Docker Compose** должны быть установлены на вашем компьютере.
- Переменные окружения хранятся в файле **`.env`**.

### Шаги для запуска

1. **Склонируйте репозиторий:**

   ```bash
   git clone https://github.com/PoBidauGustang/test_case_abol.git
   cd test_case_abol
   ```

2. **Скопируйте файл с переменными окружения env-example в корень проекта в файл .env:**

   ```bash
   cp env-example .env
   ```

3. **Скопируйте файл с тестовыми переменными окружения env-example.test в корень проекта в файл .env.test:**

   ```bash
   cp env-example.test .env.test
   ```

4. **Запустите тесты с помощью Docker Compose:**

   ```bash
   docker compose -f docker-compose.test.yml --env-file .env.test up --build
   ```

   Docker Compose запустит все тесты на тестовой базе данных.

5. **Остановка проекта:**
   Чтобы остановить тесты, используйте команду:

   ```bash
   docker-compose -f docker-compose.test.yml down -v
   ```

6. **Запустите проект с помощью Docker Compose:**

   ```bash
   docker-compose up --build
   ```

   Docker Compose запустит все необходимые сервисы: **PostgreSQL**, **Redis**, **RabbitMQ**, **gRPC сервер** и **FastAPI**.

7. **Остановка проекта:**
   Чтобы остановить проект, используйте команду:

   ```bash
   docker-compose down
   ```

### Открытая документация (OpenAPI)

Документация **OpenAPI** для REST API доступна по адресу:

```bash
http://127.0.0.1:8000/book/openapi
```

Это автоматически сгенерированная документация, которая предоставляет полное описание всех доступных эндпоинтов и их параметров.

### Файл protobuf

Файл **protobuf** для gRPC находится по следующему пути:

```bash
grpc_app/grpc_server/books.proto
```

Этот файл содержит описание gRPC методов для работы с книгами, такие как получение информации о книге по ID и получение списка всех книг.

### Requirements.txt

В проекте для управления зависимостями используется Poetry, но для удобства предоставлен файл requirements.txt в корне проекта:

```bash
requirements.txt
```

### Удаленный вызов процедур - gRPC через Flask

### Как вызывать gRPC методы удаленно через Flask

В проекте развернуто приложение на **Flask**, которое выполняет роль gRPC-клиента. Оно позволяет взаимодействовать с gRPC-сервисом через HTTP-запросы. Это облегчает вызов gRPC-методов для тех, кто привык работать с HTTP-запросами (например, с помощью `curl`), и предоставляет удобную точку входа для взаимодействия с gRPC через REST-подобный интерфейс.

### Пример вызова gRPC методов через Flask

После того как Flask-клиент запущен, его можно использовать для отправки HTTP-запросов, которые будут обращаться к gRPC-сервису.

1. **Получение информации о книге по ID**

   Вы можете отправить HTTP GET запрос на Flask-клиент, чтобы получить информацию о книге по её UUID.

   Пример запроса:

   ```bash
   curl -X GET http://localhost:5000/books/<uuid>
   ```

   **Пример ответа**:

   ```json
   {
     "uuid": "123e4567-e89b-12d3-a456-426614174000",
     "title": "The Great Gatsby",
     "author": "F. Scott Fitzgerald",
     "published_date": "1925-04-10"
   }
   ```

   Этот запрос вызывает gRPC метод **`GetBookById`** через Flask-клиент, который перенаправляет его на gRPC-сервис.

2. **Получение списка всех книг**

   Для получения списка всех книг можно сделать запрос:

   ```bash
   curl -X GET http://localhost:5000/books
   ```

   **Пример ответа**:

   ```json
   [
     {
       "uuid": "123e4567-e89b-12d3-a456-426614174000",
       "title": "The Great Gatsby",
       "author": "F. Scott Fitzgerald",
       "published_date": "1925-04-10"
     },
     {
       "uuid": "987e6543-e21b-32d3-b456-426614174111",
       "title": "To Kill a Mockingbird",
       "author": "Harper Lee",
       "published_date": "1960-07-11"
     }
   ]
   ```

   Этот запрос перенаправляется через Flask на gRPC метод **`GetAllBooks`**.

### Запуск Flask-клиента

1. После запуска **docker-compose.yml** со всеми контейнерами, Flask-клиент будет доступен по адресу `http://localhost:5000`.
2. Используйте `curl` или другие инструменты для выполнения HTTP-запросов, которые Flask будет перенаправлять к gRPC-сервису.
